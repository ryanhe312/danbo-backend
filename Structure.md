# 蛋博后端设计文档

版本 20201202.3

## 一、简介

### 1.框架与环境

蛋博后端使用Python写成，调用了django框架，django 是一个开放源代码的 Web 应用框架，由 Python 写成。django 采用了 MVT 的软件设计模式，即模型（Model），视图（View）和模板（Template）。

在这里我们仅仅使用了模型和视图来构建我们的Web API，模型用来存储数据，视图里面实现了各种功能接口，使得后端成为前端能够调用的各种文件和数据库的接口的实现。

数据库接口使用了默认的Sqlite3数据库，实现了自给自足的、无服务器的、零配置的、事务性的 SQL 数据库引擎，满足了用户信息的高效存储。

### 2.功能与交互

后端负责用户，博文，评论等相关功能的模型（数据库）实现和增删改查的接口包装，完成登陆注册，发布博文，发表评论，搜索博文等等功能。

前后端通过本机网络中HTTP通信，前端一般发送POST信息，后端根据这个信息进行响应，返回前端所需要的信息。前端只需要专注于用户引导和显示，后端负责业务处理和数据持久化的工作。这样前后端有效的进行解耦，能够区分功能，加快设计编码效率。

## 二、用户模块

### 1.模型

* 用户模型：它包括用户名（主键），密码，邮箱（主键），昵称，签名，生日，性别，地址字段。

* 验证码模型：它包括邮箱（外键），验证码，时间戳，发出时间字段。

* 头像模型：它包括关联的用户和图片字段。
* 关注模型：它包括关注者与被关注者的用户名，我们把关注抽象成一个模型，连接关注者与被关注者，可以方便利用外键查找。

### 2.视图

#### 登陆API

（1）注册功能：用户首先提供邮箱，然后接受验证邮件，收到验证码，然后将用户名，密码，邮箱和验证码一起提交即可。注意只有当最后注册的时候才会提交所有信息，后端会在这时进行查验是否符合规范。我们在后端实现了发送验证邮件和注册的接口，发送验证邮件对应了注册页面的“验证邮箱”按钮，注册对应了最后的“注册”按钮。

（2）登陆功能只需要提供用户名和密码，然后提交。后端进行查验之后即登陆成功。

（3）在登陆功能旁边就是修改密码/找回密码的功能，这个和注册一样首先提供邮箱，然后接受验证邮件，收到验证码，然后将用户名，密码，邮箱和验证码一起提交即可。该页面同样应有“验证邮箱”和“修改”按钮。

#### 用户API

其他信息需要在个人信息展示进行修改，我们针对每一种信息，编写了修改接口和获取接口。前端只需要提供当前用户登录的Cookie信息和响应修改的字段就可以了。注意修改头像必须传递文件，获取头像返回值是相对路径，加上前缀才能获取真实路径。

#### 关注API

（1）获取关注列表与被关注列表：我们可以根据用户名找到他的关注者与被关注者，这对于用户的社交管理很有意义。

（2）关注与取消关注：我们提供了自由的关注和取消关注功能，用户可以在他人的个人资料页对其进行修改。

## 三、博客模块

### 1.模型

* 博客模型：它包括发布博客的用户（外键），发布时间，文本内容字段，博客类别（转发/原创），转发指针（转发博客的 id 值）。后端采用链表结构存储转发博客，只有原博客才有图片，其他博客都指向各自的原博客。
* 图片模型：它包括图片所属的博客（外键），图片编号，图片路径字段。由于图片是依赖博客的，我们查询图片的时候是根据所属博客进行查询，将博客关联的图片与博客内容一起返回，我们创建的时候也是必须先有博客然后才放入相应的图片。获取的图片路径也是相对路径，需要加上前缀获得根据网址的绝对路径。
* 点赞模型：它包括点赞所属的博客和点赞用户。描述了用户和博客之间的一种关系，博客的点赞数会显示在博客的下方。
* 评论模型：它包括评论所属的博客和评论用户，还有评论时间与评论内容。
* 话题模型：它包括了话题的名字和发布时间
* 标签模型：它描述了话题和博客之间的关系，我们能通过博客找到关联的话题，也能够通过话题找到相关的博客。

### 2.视图

#### 博客API

（1）发送博客：需要提供文字内容和图片。我们后端根据用户Cookie，将当前时间和文字内容存入博客模型，生成博客实例之后，我们再根据创建的博客存入图片。图片可以存入多张，将会用不同的序号进行存储，保持上传时候的顺序。

（2）转发博客：与发送博客不同的是，这里只需要提供文字和转发的博客ID，由前端提供相应信息。这样的转发博客只有文字信息和用户信息，实际的内容是由转发的博客决定。

（3）点赞与取消点赞：点赞按钮在博客下方，前端通过发送用户Cookie和博客ID请求后端，后端会在数据库中相应记录。

（4）评论：评论也是在博客下方展现，前端通过发送用户Cookie和博客ID、评论内容请求后端，后端会在数据库中相应记录。

（5）获取用户博客：需要相应的用户名，后端能从博客中选取相应用户的博客，然后再根据博客选取出相应博客的图片，打包成{id：博客内容}的词典类型返回给前端。根据链式结构，我们迭代查询原博客，并记录每级转发的用户名和博客内容。直到遇到原博客，才寻找图片并返回。

（6）获取信息流：与获取博客不同的是，这里获取的是本人和关注者的博客。

（7）获取点赞和获取评论：与点赞评论相对应，前端会在加载博客时同时加载点赞和评论内容，只需要对后端发送博客ID就能获得相应内容。

#### 话题API

（1）获取话题关联博客：通过话题名字找到关联博客并返回，用于构建话题页面。

（2）获取话题热榜：列出原创博客数最多的10个话题，如果不足10个则全部列出，用于构建热搜组件。

## 四、交叉模块

### 1.视图

#### 搜索API

（1）搜索话题：通过一个正则表达式匹配所有话题，返回相关话题名列表，用于构建搜索页面。

（2）搜索用户：通过一个正则表达式匹配所有用户，返回相关用户名列表，用于构建搜索页面。